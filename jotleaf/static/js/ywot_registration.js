// Generated by CoffeeScript 1.4.0
var ACCEPTABLE_HOSTS, TRANSFER_CHECK, TRANSFER_RESPONSE, clickedNo, clickedYes, promptTransfer, receiveYwotMessage;

ACCEPTABLE_HOSTS = ['localhost:8000', 'localhost:8001', 'yourworldoftext.com', 'www.yourworldoftext.com', 'dev.yourworldoftext.com:8001'];

TRANSFER_CHECK = '/mkt/ywot_transfer_check/';

TRANSFER_RESPONSE = '/mkt/ywot_transfer_response/';

clickedYes = function(data) {
  log("clicked yes");
  data.response = 'yes';
  $('.ywot-transfer').hide('slow');
  return $.ajax({
    type: 'POST',
    url: TRANSFER_RESPONSE,
    data: data,
    dataType: 'json',
    success: function() {
      return window.location.href = '/home/';
    },
    error: function() {
      return $('.ywot-transfer').show().text('Sorry, there was an error transferring your account.');
    }
  });
};

clickedNo = function(data) {
  log("clicked no");
  data.response = 'no';
  $('.ywot-transfer').hide('slow');
  return $.ajax({
    type: 'POST',
    url: TRANSFER_RESPONSE,
    data: data,
    dataType: 'json'
  });
};

promptTransfer = function(data) {
  var transferCheck;
  log("prompt got", data.username, data.sig);
  transferCheck = $.ajax({
    type: 'POST',
    url: TRANSFER_CHECK,
    data: data,
    dataType: 'json'
  });
  transferCheck.done(function(response) {
    var c, contents, n, p, prompt, y, _i, _len;
    if (!response) {
      return;
    }
    if (response.transfer_status !== null) {
      return;
    }
    contents = [];
    contents.push($('<span>').text("It looks like you're logged in to yourworldoftext.com as '" + data.username + "'."));
    contents.push('<br>');
    prompt = $('<span>').text("Would you like to sign in to Jotleaf using the same credentials?");
    y = $('<span class="response">').text('Yes').click((function() {
      return clickedYes(data);
    })).appendTo(prompt);
    n = $('<span class="response">').text('No').click((function() {
      return clickedNo(data);
    })).appendTo(prompt);
    contents.push(prompt);
    p = $('.ywot-transfer');
    assert(p.length);
    for (_i = 0, _len = contents.length; _i < _len; _i++) {
      c = contents[_i];
      p.append(c);
    }
    return p.show();
  });
  return transferCheck.fail(function(response) {
    return log("ywot prompt error:", response);
  });
};

receiveYwotMessage = function(msg) {
  var d, host, originValid, url, _i, _len;
  log("got postMessage", msg);
  originValid = false;
  for (_i = 0, _len = ACCEPTABLE_HOSTS.length; _i < _len; _i++) {
    host = ACCEPTABLE_HOSTS[_i];
    url = "http://" + host;
    if (msg.origin === url) {
      originValid = true;
    }
  }
  if (!originValid) {
    log("Invalid message origin:", msg.origin);
    return;
  }
  d = msg.data;
  if (!d.username) {
    log("User not authenticated to YWOT");
    return;
  }
  log("User is authenticated to YWOT as", d.username);
  return promptTransfer(d);
};

window.addEventListener("message", receiveYwotMessage, false);
